# Ubuntu packages
sudo apt-get update && sudo apt-get install -y portaudio19-dev libasound2-dev libportaudio2 libportaudiocpp0 libsndfile1-dev libpulse-dev ffmpeg

# UV instructions
uv init --python 3.11
uv sync
uv add -r server/requirements.txt

uv add stable-fast --no-build-isolation


mkdir -p ~/.gnupg
echo "pinentry-program /usr/bin/pinentry-curses
allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
chmod 600 ~/.gnupg/gpg-agent.conf

gpg-connect-agent reloadagent /bye

export GPG_TTY=$(tty)

wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.0-1_all.deb 
sudo dpkg -i cuda-keyring_1.0-1_all.deb 
sudo apt update && sudo apt upgrade
sudo apt install libcudnn8 libcudnn8-dev

User ↔ FastAPI App (Main WebSocket)
         ↓
    Process Request → Check Prompt Travel Enabled?
         ↓                    ↓
[Regular Processing]   [Prompt Travel Enabled]
                             ↓
                     Submit to Embeddings Service
                             ↓
                     Add to Pending Queue
                             ↓
                  Process in Background Task
                             ↓
                      Store in Cache
                             ↓
                   Retrieve for Pipeline
                             ↓
                   Generate Final Image

GIT_SSH_COMMAND="ssh -i ~/.ssh/id_GT2" git add .

echo "pinentry-program /usr/bin/pinentry-curses" > ~/.gnupg/gpg-agent.conf && gpgconf --kill gpg-agent
export GPG_TTY=$(tty) && echo "export GPG_TTY=\$(tty)" >> ~/.bashrc

uv run server/tensorrt_convert/sd_to_onnx.py --model_path stabilityai/sd-turbo --controlnet_path thibaud/controlnet-sd21-depth-diffusers thibaud/controlnet-sd21-canny-diffusers --output_path server/tensorrt_convert/onnx_models

# Using local depth sd2.1 controlnet
uv run server/tensorrt_convert/sd_to_onnx.py --model_path stabilityai/sd-turbo --controlnet_path server/tensorrt_convert/checkpoints/diffusion_pytorch_model.safetensors --output_path server/tensorrt_convert/onnx_models
uv run server/tensorrt_convert/convert_all_models.py

uv run server/pipelines/trtControlnetImg2Img.py --sd_model "stabilityai/sd-turbo" --onnx_model_dir "server/tensorrt_convert/onnx_models" --unet_engine_path "server/tensorrt_convert/onnx_models/unet/unet.engine" --qr_img_path "server/assets/mountain.png"

uv pip install -v -U git+https://github.com/chengzeyi/stable-fast.git@main#egg=stable-fast --no-build-isolation